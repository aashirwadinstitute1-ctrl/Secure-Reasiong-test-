<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Secure Reasoning Exam — Admin & Student</title>
<style>
  :root{--brand:#2563eb;--ok:#16a34a;--danger:#dc2626;--bg:#f3f4f6}
  body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);margin:0;padding:18px}
  .wrap{max-width:1100px;margin:12px auto}
  .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.06);margin-bottom:14px}
  h1,h2{margin:0 0 12px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  input,select,textarea,button{font-family:inherit}
  input,select,textarea{padding:8px;border:1px solid #e6e6e6;border-radius:8px}
  button{background:var(--brand);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.secondary{background:#6b7280}
  .muted{color:#6b7280;font-size:14px}
  .small{font-size:13px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  img.thumb{width:48px;height:48px;border-radius:6px;object-fit:cover}
  video#cam{width:160px;height:120px;border-radius:8px;background:#000}
  .nav{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
  .nav button{min-width:36px;padding:6px;border-radius:8px;border:0;color:#fff;font-weight:700}
  .nav .red{background:var(--danger)}
  .nav .green{background:var(--ok)}
  .nav .blue{background:var(--brand)}
  .question-box{margin-top:12px;padding:12px;border-radius:8px;border:1px solid #eee;background:#fafafa}
  .controls{display:flex;gap:8px;align-items:center;margin-top:10px}
  .right{margin-left:auto}
  .danger{color:var(--danger)}
  .ok{color:var(--ok)}
  pre.small{font-size:12px;padding:8px;background:#f9fafb;border-radius:8px}
  @media(max-width:820px){.row{flex-direction:column}}
</style>
</head>
<body>
<div class="wrap">

  <div class="card" id="loginCard">
    <h1>Secure Reasoning Exam</h1>
    <div class="row" style="align-items:center">
      <label class="small">Login as:</label>
      <select id="roleSelector"><option value="student">Student</option><option value="admin">Admin</option></select>
      <input id="nameInput" placeholder="Name" style="flex:1" />
      <input id="idInput" placeholder="ID (for student) / username (admin)" style="width:180px" />
      <input id="passInput" placeholder="Password" style="width:160px" type="password" />
      <button onclick="doLogin()">Login</button>
      <div class="muted small" style="margin-left:8px">Admin: <b>Ashish pandey</b> / 639314 · Student: <b>Bhumika</b> / 7347</div>
    </div>
    <p class="small muted" style="margin-top:10px">Use the role selector to login as Admin or Student.</p>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div class="card" id="adminCard" style="display:none">
    <div class="row">
      <h2>Admin Dashboard</h2>
      <div class="right">
        <button onclick="logout()">Logout</button>
      </div>
    </div>

    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
      <!-- Students -->
      <div style="flex:1;min-width:300px">
        <h3>Students</h3>
        <div class="row">
          <input id="stuName" placeholder="Name">
          <input id="stuId" placeholder="ID" style="width:120px">
          <input id="stuMobile" placeholder="Mobile" style="width:140px">
        </div>
        <div class="row" style="margin-top:8px">
          <input id="stuPhotoUrl" placeholder="Photo URL (or upload below)" style="flex:1">
          <button onclick="addStudent()">Add Student</button>
        </div>
        <div style="margin-top:8px">
          <label class="small">Or choose photo file: </label>
          <input type="file" id="stuPhotoFile" accept="image/*">
        </div>

        <h4 style="margin-top:12px">Student List</h4>
        <table id="studentsTable"><thead><tr><th>Photo</th><th>Name</th><th>ID</th><th>Mobile</th><th></th></tr></thead><tbody></tbody></table>
      </div>

      <!-- Questions -->
      <div style="flex:1;min-width:320px">
        <h3>Questions</h3>
        <textarea id="qText" rows="3" placeholder="Question text" style="width:100%"></textarea>
        <div class="row" style="margin-top:8px">
          <input id="opA" placeholder="Option A" style="flex:1">
          <input id="opB" placeholder="Option B" style="flex:1">
        </div>
        <div class="row" style="margin-top:8px">
          <input id="opC" placeholder="Option C" style="flex:1">
          <input id="opD" placeholder="Option D" style="flex:1">
        </div>
        <div class="row" style="margin-top:8px">
          <label class="small">Correct</label>
          <select id="correctSelect"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
          <button onclick="addQuestion()">Add Question</button>
          <button class="secondary" onclick="clearQuestions()">Clear All</button>
        </div>

        <h4 style="margin-top:12px">Question list</h4>
        <div style="max-height:280px;overflow:auto;border:1px solid #f1f1f1;padding:8px;border-radius:8px" id="questionList"></div>

      </div>
    </div>

    <!-- Results -->
    <div style="margin-top:14px">
      <h3>Results</h3>
      <table id="resultsTable"><thead><tr><th>Student ID</th><th>Name</th><th>Score</th><th>Violations</th><th>Start</th><th>End</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- Import/Export -->
    <div style="margin-top:12px" class="row">
      <div style="flex:1">
        <label class="small">Export Questions JSON</label>
        <pre id="exportArea" class="small" style="white-space:pre-wrap"></pre>
      </div>
      <div style="width:320px">
        <label class="small">Import Questions (paste JSON)</label>
        <textarea id="importArea" rows="6" style="width:100%"></textarea>
        <button onclick="importQuestions()">Import</button>
      </div>
    </div>
  </div>

  <!-- STUDENT EXAM -->
  <div class="card" id="examCard" style="display:none">
    <div class="row">
      <h2>Exam — Student Panel</h2>
      <div class="right">
        <button onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="row" style="align-items:flex-start;margin-top:10px">
      <div style="flex:1;min-width:420px">
        <div class="row">
          <div>
            <div class="small muted">Student</div>
            <div id="stuInfo" style="font-weight:700"></div>
          </div>
          <div class="right">
            <div class="small muted">Time Left</div>
            <div id="timeLeft" style="font-weight:700;color:var(--danger)">40:00</div>
          </div>
        </div>

        <div class="question-box" id="questionBox" style="margin-top:12px">
          <div id="qTextDisplay" style="font-weight:700"></div>
          <div id="optionsDisplay" style="margin-top:8px"></div>
          <div class="controls">
            <button onclick="prevQ()" class="secondary">◀ Prev</button>
            <button id="nextQBtn" onclick="goNext()">Next ▶</button>
            <div class="right muted small">Violations: <span id="violCount">0</span></div>
          </div>
        </div>

        <div style="margin-top:10px">
          <button onclick="submitExam()" style="background:#16a34a">Submit Exam</button>
        </div>
      </div>

      <div style="width:220px">
        <video id="cam" autoplay muted playsinline></video>
        <div style="margin-top:10px" class="muted small">Camera Preview (visible to student)</div>
        <div style="margin-top:12px">
          <div class="muted small">Question Navigator</div>
          <div id="navRow" class="nav" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- SUBMIT SCREEN -->
  <div class="card" id="submitCard" style="display:none">
    <h2>Test Submitted</h2>
    <p id="finalSummary" class="ok"></p>
    <p class="muted">Result saved. Admin can view results in Admin panel.</p>
    <button onclick="logout()">Finish</button>
  </div>

</div>

<script>
/* -------------------------
   Storage keys & defaults
   ------------------------- */
const USERS_KEY = 'users_v2';
const Q_KEY = 'questions_v2';
const R_KEY = 'results_v2';
const CUR_KEY = 'currentUser_v2';

let users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
let questions = JSON.parse(localStorage.getItem(Q_KEY) || '[]');
let results = JSON.parse(localStorage.getItem(R_KEY) || '[]');

if(!users['admin']) {
  // default admin & student
  users['admin'] = { username: 'Ashish pandey', password: '639314', role:'admin' };
  users['Bhumika'] = { id:'7347', name:'Bhumika', password:'7347', mobile:'', photo:'' , role:'student' };
  saveUsers();
}

/* ---------- Helpers ---------- */
function saveUsers(){ localStorage.setItem(USERS_KEY, JSON.stringify(users)); }
function saveQuestions(){ localStorage.setItem(Q_KEY, JSON.stringify(questions)); renderQuestionList(); exportQuestionsText(); }
function saveResults(){ localStorage.setItem(R_KEY, JSON.stringify(results)); renderResultsTable(); }
function setCurrent(user){ localStorage.setItem(CUR_KEY, JSON.stringify(user)); }
function clearCurrent(){ localStorage.removeItem(CUR_KEY); }

/* ---------- Login / Routing ---------- */
function doLogin(){
  const role = document.getElementById('roleSelector').value;
  const name = document.getElementById('nameInput').value.trim();
  const idoruser = document.getElementById('idInput').value.trim();
  const pw = document.getElementById('passInput').value.trim();

  if(role === 'admin'){
    // match admin (username in users['admin'].username)
    const admin = users['admin'];
    if((name.toLowerCase() === admin.username.toLowerCase() || idoruser === admin.username) && pw === admin.password){
      setCurrent({ role:'admin', username: admin.username }); showAdmin();
      return;
    } else { alert('Invalid admin credentials'); return; }
  } else {
    // student login: match by name or id
    const s = Object.values(users).find(u => u.role==='student' && (u.name && u.name.toLowerCase()===name.toLowerCase() || u.id===idoruser));
    if(!s){ alert('Student not found. Please ask admin to add student'); return; }
    if(pw !== s.password){ alert('Wrong password'); return; }
    setCurrent({ role:'student', id: s.id, name: s.name }); showExamForStudent(s); return;
  }
}

function logout(){
  clearCurrent();
  document.getElementById('loginCard').style.display='block';
  document.getElementById('adminCard').style.display='none';
  document.getElementById('examCard').style.display='none';
  document.getElementById('submitCard').style.display='none';
  // clear runtime exam data
  stopCameraTrack();
}

/* ---------- ADMIN UI ---------- */
function showAdmin(){
  document.getElementById('loginCard').style.display='none';
  document.getElementById('adminCard').style.display='block';
  document.getElementById('examCard').style.display='none';
  document.getElementById('submitCard').style.display='none';
  renderStudentsTable();
  renderQuestionList();
  renderResultsTable();
  exportQuestionsText();
}

/* Students management */
function addStudent(){
  const name = document.getElementById('stuName').value.trim();
  const id = document.getElementById('stuId').value.trim();
  const mobile = document.getElementById('stuMobile').value.trim();
  let photo = document.getElementById('stuPhotoUrl').value.trim();

  // if file chosen, read as dataURL
  const fileInput = document.getElementById('stuPhotoFile');
  if(fileInput && fileInput.files && fileInput.files[0]){
    const reader = new FileReader();
    reader.onload = function(e){
      photo = e.target.result;
      storeStudent(name,id,mobile,photo);
    };
    reader.readAsDataURL(fileInput.files[0]);
    return;
  }
  storeStudent(name,id,mobile,photo);
}

function storeStudent(name,id,mobile,photo){
  if(!name || !id){ alert('Name and ID required'); return; }
  users[name] = { id, name, password: id.toString().slice(-4) || '0000', mobile, photo, role:'student' };
  saveUsers(); renderStudentsTable();
  document.getElementById('stuName').value=''; document.getElementById('stuId').value=''; document.getElementById('stuMobile').value=''; document.getElementById('stuPhotoUrl').value='';
  alert('Student added. Default password = last 4 chars of ID (or ID).');
}

function renderStudentsTable(){
  const tbody = document.querySelector('#studentsTable tbody');
  tbody.innerHTML = '';
  Object.values(users).filter(u=>u.role==='student').forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.photo?'<img class="thumb" src="'+s.photo+'">':''}</td><td>${s.name}</td><td>${s.id||''}</td><td>${s.mobile||''}</td><td><button onclick="deleteStudent('${s.name}')">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}
function deleteStudent(name){
  if(!confirm('Delete student '+name+' ?')) return;
  delete users[name]; saveUsers(); renderStudentsTable();
}

/* Questions management */
function addQuestion(){
  const text = document.getElementById('qText').value.trim();
  const A = document.getElementById('opA').value.trim();
  const B = document.getElementById('opB').value.trim();
  const C = document.getElementById('opC').value.trim();
  const D = document.getElementById('opD').value.trim();
  const correct = document.getElementById('correctSelect').value;
  if(!text||!A||!B||!C||!D){ alert('Fill all fields'); return; }
  questions.push({ id: questions.length+1, text, options:{A,B,C,D}, correct });
  saveQuestions();
  document.getElementById('qText').value=''; document.getElementById('opA').value=''; document.getElementById('opB').value=''; document.getElementById('opC').value=''; document.getElementById('opD').value='';
}
function renderQuestionList(){
  const box = document.getElementById('questionList');
  box.innerHTML = '';
  questions.forEach((q,idx)=>{
    const div = document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid #f1f1f1';
    div.innerHTML = `<b>#${idx+1}</b> ${escapeHtml(q.text)} <div class="small muted">A:${escapeHtml(q.options.A)} | B:${escapeHtml(q.options.B)} | C:${escapeHtml(q.options.C)} | D:${escapeHtml(q.options.D)}</div>
      <div style="margin-top:6px"><button onclick="deleteQuestion(${idx})" style="background:#ef4444">Delete</button></div>`;
    box.appendChild(div);
  });
}
function deleteQuestion(idx){
  if(!confirm('Delete question #'+(idx+1)+' ?')) return;
  questions.splice(idx,1); // re-index not strictly needed
  saveQuestions();
}
function clearQuestions(){
  if(!confirm('Delete ALL questions?')) return;
  questions=[]; saveQuestions();
}

/* Results */
function renderResultsTable(){
  const tbody = document.querySelector('#resultsTable tbody');
  tbody.innerHTML = '';
  results.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.id||''}</td><td>${r.name||''}</td><td>${r.score}/${questions.length}</td><td>${r.violations||0}</td><td>${r.start||''}</td><td>${r.end||''}</td>`;
    tbody.appendChild(tr);
  });
}

/* Import / Export */
function exportQuestionsText(){
  document.getElementById('exportArea').textContent = JSON.stringify(questions, null, 2);
}
function importQuestions(){
  try{
    const txt = document.getElementById('importArea').value;
    const arr = JSON.parse(txt);
    if(!Array.isArray(arr)) throw 'Invalid';
    questions = arr;
    saveQuestions();
    alert('Imported '+arr.length+' questions');
  }catch(e){ alert('Invalid JSON'); }
}

/* ---------- STUDENT EXAM UI ---------- */
let timerInterval = null;
let timeLeft = 40*60; // seconds
let currentIndex = 0;
let answers = {};
let violations = 0;
let camStream = null;

function showExamForStudent(studentObj){
  document.getElementById('loginCard').style.display='none';
  document.getElementById('adminCard').style.display='none';
  document.getElementById('examCard').style.display='block';
  document.getElementById('submitCard').style.display='none';
  // show student info
  document.getElementById('stuInfo').textContent = (studentObj.name||'') + ' ('+(studentObj.id||'')+')';
  // load questions array if empty: if no questions, seed with provided 80 default ones
  if(questions.length===0){
    questions = seedDefaultQuestions(); saveQuestions();
  }
  // prepare answers array
  answers = {};
  violations = 0; updateViolCount();
  currentIndex = 0;
  renderQuestion(currentIndex);
  renderNav();
  startExamTimer();
  startCamPreview();
  // anti-cheat hooks
  ['copy','paste','contextmenu'].forEach(e => document.addEventListener(e, blockEvent));
  document.addEventListener('visibilitychange', onVisibilityChange);
}

function blockEvent(ev){ ev.preventDefault(); violations++; updateViolCount(); }
function onVisibilityChange(){ if(document.hidden){ violations++; updateViolCount(); } }

function renderQuestion(index){
  if(index<0) index=0;
  if(index>=questions.length) index=questions.length-1;
  currentIndex = index;
  const q = questions[index];
  if(!q){ document.getElementById('qTextDisplay').innerText='No questions available'; document.getElementById('optionsDisplay').innerHTML=''; return; }
  document.getElementById('qTextDisplay').innerText = 'Q'+(index+1)+'. '+q.text;
  const optHtml = ['A','B','C','D'].map(k=>{
    const txt = q.options[k] || '';
    const checked = answers[index]===k ? 'checked' : '';
    return `<div style="margin-top:6px"><label><input type="radio" name="opt" value="${k}" ${checked} onchange="chooseAnswer('${k}')"> ${k}) ${escapeHtml(txt)}</label></div>`;
  }).join('');
  document.getElementById('optionsDisplay').innerHTML = optHtml;
  document.getElementById('nextQBtn').disabled = !(answers[index]!==undefined);
  renderNav();
}
function chooseAnswer(letter){
  answers[currentIndex] = letter;
  document.getElementById('nextQBtn').disabled = false;
  renderNav();
}
function prevQ(){ if(currentIndex>0){ currentIndex--; renderQuestion(currentIndex); } }
function goNext(){
  if(answers[currentIndex]===undefined){ alert('Please select an answer before proceeding'); return; }
  if(currentIndex < questions.length-1){ currentIndex++; renderQuestion(currentIndex); }
  else { alert('This was the last question'); }
}
function renderNav(){
  const row = document.getElementById('navRow');
  row.innerHTML = '';
  for(let i=0;i<questions.length;i++){
    let cls = 'red';
    if(answers[i]!==undefined) cls='green';
    if(i===currentIndex) cls='blue';
    const btn = document.createElement('button');
    btn.className = cls;
    btn.textContent = (i+1);
    btn.onclick = ()=>{ renderQuestion(i); };
    row.appendChild(btn);
  }
}

/* Timer & camera */
function startExamTimer(){
  timeLeft = 40*60;
  document.getElementById('timeLeft').textContent = formatTime(timeLeft);
  clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    timeLeft--;
    document.getElementById('timeLeft').textContent = formatTime(timeLeft);
    if(timeLeft<=0){ clearInterval(timerInterval); alert('Time over — submitting'); submitExam(); }
  },1000);
}
function formatTime(sec){ const m=Math.floor(sec/60); const s=sec%60; return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }

async function startCamPreview(){
  try{
    camStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
    document.getElementById('cam').srcObject = camStream;
  }catch(e){ console.warn('Camera denied', e); }
}
function stopCameraTrack(){ try{ if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null;} }catch(e){} }
function updateViolCount(){ document.getElementById('violCount').innerText = violations; }

/* Submit exam */
function submitExam(){
  // finalize last choice
  // compute score
  stopCameraTrack();
  clearInterval(timerInterval);
  document.removeEventListener('visibilitychange', onVisibilityChange);
  ['copy','paste','contextmenu'].forEach(e => document.removeEventListener(e, blockEvent));
  let score = 0;
  for(let i=0;i<questions.length;i++){
    
